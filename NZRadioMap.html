<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>NZ Radio Map</title>
    <style>
      html, 
	  body, 
	  #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
	  
	   #rendererDiv {
        padding: 20px;
        width: 400px;
      }
	    .slider {
        height: 40px;
        width: 100%;
      }
	  
    </style>
	<link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.15/"></script>
    <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/widgets/BasemapToggle",
	  "esri/layers/FeatureLayer",
	  "esri/widgets/Slider",
	  "esri/widgets/Search",
	  "esri/widgets/Expand"
    ], function(Map, MapView, BasemapToggle, FeatureLayer, Slider, Search, Expand) {

      var map = new Map({
        basemap: "osm"
      });
      
      var view = new MapView({
        container: "viewDiv",
        map: map,
        center: [174.8199431,-41.2662579],
        zoom: 8
      });
      
       var basemapToggle = new BasemapToggle({
         view: view,
         secondMap: "satellite"
       });
      
       view.ui.add(basemapToggle,"bottom-right");
	   
	   const expand = new Expand({
       view: view,
       content: document.getElementById("rendererDiv"),
       expanded: true,
       expandIconClass: "esri-icon-settings2"
       });

       view.ui.add(expand, "top-right");
	   
	   //pop-up window configuration
	   var popuplicenceinfo = {
           title: "Licence ID:{licenceid}",
           content:
           "<b>licence type:</b> {licencetype}<br><b>Frequency:</b> {frequency} MHz<br><b> Spectrum Low: </b>{spectrumlow} MHz<br><b> SpectrumHigh: </b>{spectrumhigh} MHz<br><b>Power:</b> {power} dBW <br>"
       };
	   
	   // Reference the feature layer to query
       var featureLayer = new FeatureLayer({
         url: "https://services7.arcgis.com/lUmstEB5yIEwBGsx/arcgis/rest/services/Prism_Licence/FeatureServer",
		 outFields: ["*"],
         popupTemplate: popuplicenceinfo
       });
       map.add(featureLayer);
	   
	   featureLayer.renderer = {
       type: "simple",  // autocasts as new SimpleRenderer()
       symbol: {
       type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
       size: 4,
       color: "blue",
         outline: {  // autocasts as new SimpleLineSymbol()
         width: 0.5,
         color: "white"
         }
       }
       };
	   
   /*
	   var sqllicencetype = [
	   "licencetype = 'Other >=10 & <20dBW (Spectrum)'",
	   "licencetype = 'VHF FM >=40dBW (Spectrum)'",
	   "licencetype = 'Other >=20 & <30dBW (Spectrum)'",
       "licencetype = 'Other >=30dBW (Spectrum)'",	 
	   "licencetype = 'Sat Fixed Per Transponder'"
       ];
	   	   
	   var lictypeFilter = document.createElement("select");
       lictypeFilter.setAttribute("class", "esri-widget esri-select");
       lictypeFilter.setAttribute(
       "style",
       "width: 375px; font-family: Avenir Next W00; font-size: 1em;"
       );
	   
	   sqllicencetype.forEach(function (sql) {
       var option = document.createElement("option");
       option.value = sql;
       option.innerHTML = sql;
       lictypeFilter.appendChild(option);
       });
	  
	  lictypefilter.addEventListener("change", function (event) {
      lictypefilter(event.target.value);
      });
	  */

      //view.ui.add(lictypeFilter, "top-right");
	  
	  const LicIDsearch = new Search ({
	    view: view,
		container: "LicIDsearch",
		searchAllEnabled: false,
		//allPlaceholder: "Licence Search",
        sources: [
          {
          layer: featureLayer,
		  name: "Licence ID",
          searchFields: ["licenceid"],
          displayField: "licenceid",
          exactMatch: false,
		  outFields: ["*"],
		  placeholder: "Input Licence ID",
		  zoomScale: 5000000
          }
		  /*
		  {
          layer: featureLayer,
		  name: "MangementRight ID",
          searchFields: ["managementrightid"],
          displayField: "managementrightid",
          exactMatch: false,
		  outFields: ["*"],
		  placeholder: "Input MangementRight ID",
		  zoomScale: 5000000		  
		  }	
          */		  
		  ]	
	  });
	  
	  //view.ui.add(LicIDsearch, "top-right");
	   
	  function frequencyfilter(expression) {
      view.whenLayerView(featureLayer).then(function (featureLayerView) {
      featureLayerView.filter = {
      where: "spectrumlow >= " + freqstartslider.values[0] + " AND " + "spectrumhigh <= " + freqstopslider.values[0],
      };
      });
      }     
	  
	  const freqstartslider = new Slider ({
	        container: "freqstartslider",
			min: 0,
            max: 80000,
            values: [0],
            snapOnClickEnabled: false,
			labelInputsEnabled: true,
            visibleElements: {
              labels: true,
			  rangeLabels: true,			  
            }
       });
	   
	  const freqstopslider = new Slider ({
	        container: "freqstopslider",
			min: 0,
            max: 80000,
            values: [3800],
            snapOnClickEnabled: false,
			labelInputsEnabled: true,
            visibleElements: {
              labels: true,
			  rangeLabels: true			  
            }
       });
	   
      freqstartslider.on(["thumb-change", "thumb-drag"],frequencyfilter);	  
	  freqstopslider.on(["thumb-change", "thumb-drag"],frequencyfilter);    
	  	  
    });
    </script>	
	
  </head>
  <body>
    <div id="viewDiv"></div>
	  <div id="rendererDiv" class="esri-widget">
      <h3 class="esri-widget__heading">Searching Criteria</h3>
      	<label id="Licence ID: " class="esri-feature-form__label"
        >Licence ID: </label>
        <div id="LicIDsearch" class="esri-feature-form"></div><br /><br />		
      	<label id="frequencystart" class="esri-feature-form__label"
        >Frequency Start: (MHz)</label><br />
		<div id="freqstartslider" class="slider"></div><br />
      	<label id="frequencystop" class="esri-feature-form__label"
        >Frequency stop: (MHz)</label><br />		
		<div id="freqstopslider" class="slider"></div>
    </div>
  </body>
</html>
